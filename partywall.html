<!-- 
	PartyWall player 
	https://github.com/sampotts/plyr
-->

<!DOCTYPE html>
<html lang="it">
<head>
	<title>PartyWall player</title>


	<link rel="stylesheet" href="https://cdn.plyr.io/3.5.6/plyr.css" />
	<style>
		.container {
			margin: 50px auto;
			max-width: 80%;
		}

		body { 
			background-color: black;
		}
	</style>

	<script src= "js/paho-mqtt-min.js"     type="text/javascript"></script>
	<script src= "js/jquery-3.3.1.min.js"  type="text/javascript"></script>
	<script src="https://cdn.plyr.io/3.5.6/plyr.js"></script>

	<script>
		var mqtt_broker="camserver.local";
		var mqtt_port=1884;
		var mqtt_mainpage_client;

		// Genera una stringa random di caratteri
		// Viane usata per le funzioni MQTT
		var randomString = function(length) {
		    var text = "";
		    var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
		    for(var i = 0; i < length; i++) {
		        text += possible.charAt(Math.floor(Math.random() * possible.length));
		    }
		    return text;
		}
		
		function onConnect() {
			mqtt_mainpage_client.subscribe("tangowall/cmd");
			console.log("Connesso");
		}	
		
		function onMessageArrived(message) {
			json_data = JSON.parse(message.payloadString);

			// Visibility
			if (json_data.cmd=="visibility") {
				//var element=document.getElementById(json_data.element); 
		
				//element.style.visibility=json_data.value;
		
				if (json_data.value===false) {
					$("#" + json_data.element).fadeOut();
				} else {
					$("#" + json_data.element).fadeIn();
				}
			}    


			// Refresh della pagina
			if (json_data.cmd=="loadpage") {
				$("#all").fadeOut("slow",function() {
					document.location.href = json_data.value;
				});
			}
			
			// Load video
			if (json_data.cmd=="load_youtube_video") {
				youtube_id = json_data.value;

				player.on('ready', event => {
	    			//const instance = event.detail.plyr;
					player.play();
				});


				player.on('ended', event => {
					alert("Finito");
				});
				
				player.source = {
				    type: 'video',
				    sources: [
				        {
				            src: youtube_id,
				            provider: 'youtube',
				        },
				    ],
				};
			}	
				
			if (json_data.cmd=="stop") {
				player.stop();
				return;
			}
			
			if (json_data.cmd=="play") {
				player.play();
				return;
			}


		}
		
		$(document).ready(function() {
			// Interpretazione messaggi MQTT in arrivo
			mqtt_mainpage_client = new Paho.MQTT.Client(mqtt_broker, Number(mqtt_port), "/ws",randomString(20));
			mqtt_mainpage_client.onMessageArrived=onMessageArrived;
			mqtt_mainpage_client.connect({
				onSuccess:onConnect
			});
		
			// Change the second argument to your options:
			// https://github.com/sampotts/plyr/#options
			const player = new Plyr('#player', {captions: {active: true}});
			
			// Expose player so it can be used from the console
			window.player = player;
			
			//player.play();
			
		});
	</script>

	
</head>

<body>
	<div id="all">
		<div class="container">
			<div id="player" data-plyr-provider="youtube" data-plyr-embed-id="zymRNmdzF2k"></div>
		</div>
	</div>
</body>
</html>

<!--

	https://github.com/sampotts/plyr
	
-->	